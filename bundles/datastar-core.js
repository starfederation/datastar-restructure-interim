"use strict";(()=>{function Y(t,e,n){let r={};if(!n)Object.assign(r,e);else for(let s in e){let i=t[s]?.value;i==null&&(r[s]=e[s])}return r}var q={pluginType:"attribute",prefix:"store",removeNewLines:!0,preprocessors:{pre:[{pluginType:"preprocessor",name:"store",regexp:/(?<whole>.+)/g,replacer:t=>{let{whole:e}=t;return`Object.assign({...ctx.store()}, ${e})`}}]},allowedModifiers:new Set(["ifmissing"]),onLoad:t=>{let e=t.expressionFn(t),n=Y(t.store(),e,t.modifiers.has("ifmissing"));t.mergeStore(n),delete t.el.dataset[t.rawKey]}};var z="[a-zA-Z_$]+",_e=z+"[0-9a-zA-Z_$.]*";function R(t,e,n,r=!0){let s=r?_e:z;return new RegExp(`(?<whole>${t}(?<${e}>${s})${n})`,"g")}var Z={name:"action",pluginType:"preprocessor",regexp:R("\\$","action","(?<call>\\((?<args>.*)\\))",!1),replacer:({action:t,args:e})=>{let n=["ctx"];e&&n.push(...e.split(",").map(s=>s.trim()));let r=n.join(",");return`ctx.actions.${t}.method(${r})`}};var Q={name:"signal",pluginType:"preprocessor",regexp:R("\\$","signal","(?<method>\\([^\\)]*\\))?"),replacer:t=>{let{signal:e,method:n}=t,r="ctx.store()";if(!n?.length)return`${r}.${e}.value`;let s=e.split("."),i=s.pop(),o=s.join(".");return`${r}.${o}.value.${i}${n}`}};function X(t){if(!t)return"null";if(typeof t=="string")return t;if(t instanceof Window)return"Window";if(t instanceof Document)return"Document";if(t.tagName==="BODY")return"BODY";let e=new Array;for(;t.parentElement&&t.tagName!=="BODY";){if(t.id){let n=t.getAttribute("id");if(!n)throw new Error("Element has an ID but no ID attribute");e.unshift("#"+n);break}else{let n=1,r=t;for(;r.previousElementSibling;r=r.previousElementSibling,n++);e.unshift(t.tagName+":nth-child("+n+")")}t=t.parentElement}return e.join(">")}function ee(t){return t instanceof HTMLElement||t instanceof SVGElement?t:null}var me=Symbol.for("preact-signals"),g=1,v=2,T=4,S=8,N=16,b=32;function A(){E++}function k(){if(E>1){E--;return}let t,e=!1;for(;x!==void 0;){let n=x;for(x=void 0,C++;n!==void 0;){let r=n._nextBatchedEffect;if(n._nextBatchedEffect=void 0,n._flags&=~v,!(n._flags&S)&&re(n))try{n._callback()}catch(s){e||(t=s,e=!0)}n=r}}if(C=0,E--,e)throw t}function te(t){if(E>0)return t();A();try{return t()}finally{k()}}var a;var x,E=0,C=0,P=0;function ne(t){if(a===void 0)return;let e=t._node;if(e===void 0||e._target!==a)return e={_version:0,_source:t,_prevSource:a._sources,_nextSource:void 0,_target:a,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},a._sources!==void 0&&(a._sources._nextSource=e),a._sources=e,t._node=e,a._flags&b&&t._subscribe(e),e;if(e._version===-1)return e._version=0,e._nextSource!==void 0&&(e._nextSource._prevSource=e._prevSource,e._prevSource!==void 0&&(e._prevSource._nextSource=e._nextSource),e._prevSource=a._sources,e._nextSource=void 0,a._sources._nextSource=e,a._sources=e),e}function c(t){this._value=t,this._version=0,this._node=void 0,this._targets=void 0}c.prototype.brand=me;c.prototype._refresh=function(){return!0};c.prototype._subscribe=function(t){this._targets!==t&&t._prevTarget===void 0&&(t._nextTarget=this._targets,this._targets!==void 0&&(this._targets._prevTarget=t),this._targets=t)};c.prototype._unsubscribe=function(t){if(this._targets!==void 0){let e=t._prevTarget,n=t._nextTarget;e!==void 0&&(e._nextTarget=n,t._prevTarget=void 0),n!==void 0&&(n._prevTarget=e,t._nextTarget=void 0),t===this._targets&&(this._targets=n)}};c.prototype.subscribe=function(t){return V(()=>{let e=this.value,n=a;a=void 0;try{t(e)}finally{a=n}})};c.prototype.valueOf=function(){return this.value};c.prototype.toString=function(){return this.value+""};c.prototype.toJSON=function(){return this.value};c.prototype.peek=function(){let t=a;a=void 0;try{return this.value}finally{a=t}};Object.defineProperty(c.prototype,"value",{get(){let t=ne(this);return t!==void 0&&(t._version=this._version),this._value},set(t){if(t!==this._value){if(C>100)throw new Error("Cycle detected");this._value=t,this._version++,P++,A();try{for(let e=this._targets;e!==void 0;e=e._nextTarget)e._target._notify()}finally{k()}}}});function $(t){return new c(t)}function re(t){for(let e=t._sources;e!==void 0;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function se(t){for(let e=t._sources;e!==void 0;e=e._nextSource){let n=e._source._node;if(n!==void 0&&(e._rollbackNode=n),e._source._node=e,e._version=-1,e._nextSource===void 0){t._sources=e;break}}}function oe(t){let e=t._sources,n;for(;e!==void 0;){let r=e._prevSource;e._version===-1?(e._source._unsubscribe(e),r!==void 0&&(r._nextSource=e._nextSource),e._nextSource!==void 0&&(e._nextSource._prevSource=r)):n=e,e._source._node=e._rollbackNode,e._rollbackNode!==void 0&&(e._rollbackNode=void 0),e=r}t._sources=n}function y(t){c.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=P-1,this._flags=T}y.prototype=new c;y.prototype._refresh=function(){if(this._flags&=~v,this._flags&g)return!1;if((this._flags&(T|b))===b||(this._flags&=~T,this._globalVersion===P))return!0;if(this._globalVersion=P,this._flags|=g,this._version>0&&!re(this))return this._flags&=~g,!0;let t=a;try{se(this),a=this;let e=this._fn();(this._flags&N||this._value!==e||this._version===0)&&(this._value=e,this._flags&=~N,this._version++)}catch(e){this._value=e,this._flags|=N,this._version++}return a=t,oe(this),this._flags&=~g,!0};y.prototype._subscribe=function(t){if(this._targets===void 0){this._flags|=T|b;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._subscribe(e)}c.prototype._subscribe.call(this,t)};y.prototype._unsubscribe=function(t){if(this._targets!==void 0&&(c.prototype._unsubscribe.call(this,t),this._targets===void 0)){this._flags&=~b;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e)}};y.prototype._notify=function(){if(!(this._flags&v)){this._flags|=T|v;for(let t=this._targets;t!==void 0;t=t._nextTarget)t._target._notify()}};Object.defineProperty(y.prototype,"value",{get(){if(this._flags&g)throw new Error("Cycle detected");let t=ne(this);if(this._refresh(),t!==void 0&&(t._version=this._version),this._flags&N)throw this._value;return this._value}});function ie(t){return new y(t)}function ae(t){let e=t._cleanup;if(t._cleanup=void 0,typeof e=="function"){A();let n=a;a=void 0;try{e()}catch(r){throw t._flags&=~g,t._flags|=S,M(t),r}finally{a=n,k()}}}function M(t){for(let e=t._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,ae(t)}function ye(t){if(a!==this)throw new Error("Out-of-order effect");oe(this),a=t,this._flags&=~g,this._flags&S&&M(this),k()}function w(t){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=b}w.prototype._callback=function(){let t=this._start();try{if(this._flags&S||this._fn===void 0)return;let e=this._fn();typeof e=="function"&&(this._cleanup=e)}finally{t()}};w.prototype._start=function(){if(this._flags&g)throw new Error("Cycle detected");this._flags|=g,this._flags&=~S,ae(this),se(this),A();let t=a;return a=this,ye.bind(this,t)};w.prototype._notify=function(){this._flags&v||(this._flags|=v,this._nextBatchedEffect=x,x=this)};w.prototype._dispose=function(){this._flags|=S,this._flags&g||M(this)};function V(t){let e=new w(t);try{e._callback()}catch(n){throw e._dispose(),n}return e._dispose.bind(e)}var j=class{get value(){return F(this)}set value(e){te(()=>ve(this,e))}peek(){return F(this,{peek:!0})}},D=t=>Object.assign(new j,Object.entries(t).reduce((e,[n,r])=>{if(["value","peek"].some(s=>s===n))throw new Error(`${n} is a reserved property name`);return typeof r!="object"||r===null||Array.isArray(r)?e[n]=$(r):e[n]=D(r),e},{})),ve=(t,e)=>Object.keys(e).forEach(n=>t[n].value=e[n]),F=(t,{peek:e=!1}={})=>Object.entries(t).reduce((n,[r,s])=>(s instanceof c?n[r]=e?s.peek():s.value:s instanceof j&&(n[r]=F(s,{peek:e})),n),{});function I(t,e){if(typeof e!="object"||Array.isArray(e)||!e)return JSON.parse(JSON.stringify(e));if(typeof e=="object"&&e.toJSON!==void 0&&typeof e.toJSON=="function")return e.toJSON();let n=t;return typeof t!="object"&&(n={...e}),Object.keys(e).forEach(r=>{n.hasOwnProperty(r)||(n[r]=e[r]),e[r]===null?delete n[r]:n[r]=I(n[r],e[r])}),n}var be="datastar",le=`${be}-event`;var ce="0.20.0";var L=class{constructor(){this.plugins=[];this.store=D({_dsPlugins:{}});this.preprocessors=new Array;this.actions={};this.refs={};this.reactivity={signal:$,computed:ie,effect:V};this.parentID="";this.missingIDNext=0;this.removals=new Map;this.mergeRemovals=new Array;this.lastMarshalledStore="";new MutationObserver((n,r)=>{this.sendDatastarEvent("core","dom","mutation",document.body,document.body.outerHTML)}).observe(document.body,{attributes:!0,childList:!0,subtree:!0})}get version(){return ce}load(...e){e.forEach(n=>{switch(n.pluginType){case"preprocessor":if(this.plugins.find(o=>o.prefix===n.name))throw new Error(`Preprocessor ${n.name} already exists`);this.preprocessors.push(n);break;case"action":if(this.actions[n.name])throw new Error(`Action ${n.name} already exists`);if(window[n.name])throw new Error(`Action ${n.name} already exists globally`);this.actions[n.name]=n;break;case"attribute":let i=new Set(this.plugins.map(o=>o.prefix));if(n.requiredPluginPrefixes){for(let o of n.requiredPluginPrefixes)if(!i.has(o))throw new Error(`${n.prefix} requires ${o}`)}this.plugins.push(n),i.add(n.prefix),n.onGlobalInit&&(n.onGlobalInit({actions:this.actions,reactivity:this.reactivity,mergeStore:this.mergeStore.bind(this),store:this.store}),this.sendDatastarEvent("core","plugins","registration","BODY",`On prefix ${n.prefix}`));break}}),this.applyPlugins(document.body)}sendDatastarEvent(e,n,r,s,i,o={bubbles:!0,cancelable:!0,composed:!0}){let f=Object.assign({detail:{time:new Date,category:e,subcategory:n,type:r,target:X(s),message:i}},o),u=new CustomEvent(le,f);window.dispatchEvent(u)}cleanupElementRemovals(e){let n=this.removals.get(e);if(n){for(let r of n.set)r();this.removals.delete(e)}}mergeStore(e){this.mergeRemovals.forEach(s=>s()),this.mergeRemovals=this.mergeRemovals.slice(0);let n=I(this.store.value,e);this.store=D(n);let r=JSON.stringify(this.store.value);r!==this.lastMarshalledStore&&this.sendDatastarEvent("core","store","merged","STORE",r)}removeFromStore(...e){let n={...this.store.value};for(let r of e){let s=r.split("."),i=s[0],o=n;for(let f=1;f<s.length;f++){let u=s[f];o[i]||(o[i]={}),o=o[i],i=u}delete o[i]}this.store=D(n),this.applyPlugins(document.body)}upsertIfMissingFromStore(e,n){let r=e.split("."),s=this.store;for(let o=0;o<r.length-1;o++){let f=r[o];s[f]||(s[f]={}),s=s[f]}let i=r[r.length-1];s[i]||(s[i]=this.reactivity.signal(n),this.sendDatastarEvent("core","store","upsert",e,n))}signalByName(e){return this.store[e]}applyPlugins(e){let n=new Set;this.plugins.forEach((r,s)=>{this.walkDownDOM(e,i=>{s||this.cleanupElementRemovals(i);for(let o in i.dataset){let f=`${i.dataset[o]}`||"",u=f;if(!o.startsWith(r.prefix))continue;if(i.id.length===0&&(i.id=`ds-${this.parentID}-${this.missingIDNext++}`),n.clear(),r.allowedTagRegexps){let l=i.tagName.toLowerCase();if(![...r.allowedTagRegexps].some(p=>l.match(p)))throw new Error(`'${i.tagName}' not allowed for '${o}', allowed ${[[...r.allowedTagRegexps].map(p=>`'${p}'`)].join(", ")}`)}let pe=o.slice(r.prefix.length),[_,...de]=pe.split(".");if(r.mustHaveEmptyKey&&_.length>0)throw new Error(`'${o}' must have empty key`);if(r.mustNotEmptyKey&&_.length===0)throw new Error(`'${o}' must have non-empty key`);_.length&&(_=_[0].toLowerCase()+_.slice(1));let G=de.map(l=>{let[m,...p]=l.split("_");return{label:m,args:p}});if(r.allowedModifiers){for(let l of G)if(!r.allowedModifiers.has(l.label))throw new Error(`'${l.label}' is not allowed`)}let B=new Map;for(let l of G)B.set(l.label,l.args);if(r.mustHaveEmptyExpression&&u.length)throw new Error(`'${o}' must have empty expression`);if(r.mustNotEmptyExpression&&!u.length)throw new Error(`'${o}' must have non-empty expression`);let H=/;|\n/;r.removeNewLines&&(u=u.split(`
`).map(l=>l.trim()).join(" "));let ge=[...r.preprocessors?.pre||[],...this.preprocessors,...r.preprocessors?.post||[]];for(let l of ge){if(n.has(l))continue;n.add(l);let m=u.split(H),p=[];m.forEach(d=>{let h=d,K=[...h.matchAll(l.regexp)];if(K.length)for(let U of K){if(!U.groups)continue;let{groups:W}=U,{whole:he}=W;h=h.replace(he,l.replacer(W))}p.push(h)}),u=p.join("; ")}let O={store:()=>this.store,mergeStore:this.mergeStore.bind(this),upsertIfMissingFromStore:this.upsertIfMissingFromStore.bind(this),removeFromStore:this.removeFromStore.bind(this),applyPlugins:this.applyPlugins.bind(this),cleanupElementRemovals:this.cleanupElementRemovals.bind(this),walkSignals:this.walkSignals.bind(this),actions:this.actions,reactivity:this.reactivity,el:i,rawKey:o,key:_,rawExpression:f,expression:u,expressionFn:()=>{throw new Error("Expression function not created")},modifiers:B,sendDatastarEvent:this.sendDatastarEvent.bind(this)};if(!r.bypassExpressionFunctionCreation?.(O)&&!r.mustHaveEmptyExpression&&u.length){let l=u.split(H).map(d=>d.trim()).filter(d=>d.length);l[l.length-1]=`return ${l[l.length-1]}`;let m=l.map(d=>`  ${d}`).join(`;
`),p=`
  try {
    const _datastarExpression = () => {
  ${m}
    }
    const _datastarReturnVal = _datastarExpression()
    ctx.sendDatastarEvent('core', 'attributes', 'expr_eval', ctx.el, '${o} equals ' + JSON.stringify(_datastarReturnVal))
    return _datastarReturnVal
  } catch (e) {
   const msg = \`
  Error evaluating Datastar expression:
  ${m.replaceAll("`","\\`")}

  Error: \${e.message}

  Check if the expression is valid before raising an issue.
  \`.trim()
   ctx.sendDatastarEvent('core', 'attributes', 'expr_eval_err', ctx.el, msg)
   console.error(msg)
   debugger
  }
              `;try{let d=r.argumentNames||[],h=new Function("ctx",...d,p);O.expressionFn=h}catch(d){let h=new Error(`Error creating expression function for '${p}', error: ${d}`);this.sendDatastarEvent("core","attributes","expr_construction_err",O.el,String(h)),console.error(h);debugger}}let J=r.onLoad(O);J&&(this.removals.has(i)||this.removals.set(i,{id:i.id,set:new Set}),this.removals.get(i).set.add(J))}})})}walkSignalsStore(e,n){let r=Object.keys(e);for(let s=0;s<r.length;s++){let i=r[s],o=e[i],f=o instanceof c,u=typeof o=="object"&&Object.keys(o).length>0;if(f){n(i,o);continue}u&&this.walkSignalsStore(o,n)}}walkSignals(e){this.walkSignalsStore(this.store,e)}walkDownDOM(e,n,r=0){if(!e)return;let s=ee(e);if(s)for(n(s),r=0,e=e.firstElementChild;e;)this.walkDownDOM(e,n,r++),e=e.nextElementSibling}};var ue=new L;ue.load(Z,Q,q);var fe=ue;fe.load();})();
//# sourceMappingURL=datastar-core.js.map
