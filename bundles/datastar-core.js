"use strict";(()=>{var ne={pluginType:"attribute",name:"star",onLoad:()=>{alert("YOU ARE PROBABLY OVERCOMPLICATING IT")}};var re="action",se="watcher",m="preprocessor",b="attribute";var oe={pluginType:b,name:"computed",mustNotEmptyKey:!0,onLoad:t=>{let e=t.store();return e[t.key]=t.reactivity.computed(()=>t.expressionFn(t)),()=>{let r=t.store();delete r[t.key]}}};function ie(t,e,r){let n={};if(!r)Object.assign(n,e);else for(let s in e){let o=t[s]?.value;o==null&&(n[s]=e[s])}return n}var ae={pluginType:b,name:"store",removeNewLines:!0,preprocessors:{pre:[{pluginType:m,name:"store",regexp:/(?<whole>.+)/g,replacer:t=>{let{whole:e}=t;return`Object.assign({...ctx.store()}, ${e})`}}]},allowedModifiers:new Set(["ifmissing"]),onLoad:t=>{let e=t.expressionFn(t),r=ie(t.store(),e,t.modifiers.has("ifmissing"));t.mergeSignals(r),delete t.el.dataset[t.rawKey]}};var ue="[a-zA-Z_$]+",we=ue+"[0-9a-zA-Z_$.]*";function I(t,e,r,n=!0){let s=n?we:ue;return new RegExp(`(?<whole>${t}(?<${e}>${s})${r})`,"g")}var le={name:"action",pluginType:m,regexp:I("\\$","action","(?<call>\\((?<args>.*)\\))",!1),replacer:({action:t,args:e})=>{let r=["ctx"];e&&r.push(...e.split(",").map(s=>s.trim()));let n=r.join(",");return`ctx.actions.${t}.method(${n})`}};var ce={name:"signal",pluginType:m,regexp:I("\\$","signal","(?<method>\\([^\\)]*\\))?"),replacer:t=>{let{signal:e,method:r}=t,n="ctx.store()";if(!r?.length)return`${n}.${e}.value`;let s=e.split("."),o=s.pop(),a=s.join(".");return`${n}.${a}.value.${o}${r}`}};var v=t=>{let e=new Error;e.name=`Status${t}`},d=v(400),D=v(409),F=v(404),T=v(403),fe=v(405),ze=v(503);function pe(t){return t instanceof HTMLElement||t instanceof SVGElement?t:null}var Oe=Symbol.for("preact-signals"),g=1,E=2,N=4,w=8,k=16,R=32;function j(){P++}function G(){if(P>1){P--;return}let t,e=!1;for(;A!==void 0;){let r=A;for(A=void 0,H++;r!==void 0;){let n=r._nextBatchedEffect;if(r._nextBatchedEffect=void 0,r._flags&=~E,!(r._flags&w)&&he(r))try{r._callback()}catch(s){e||(t=s,e=!0)}r=n}}if(H=0,P--,e)throw t}function de(t){if(P>0)return t();j();try{return t()}finally{G()}}var i;var A,P=0,H=0,M=0;function ge(t){if(i===void 0)return;let e=t._node;if(e===void 0||e._target!==i)return e={_version:0,_source:t,_prevSource:i._sources,_nextSource:void 0,_target:i,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},i._sources!==void 0&&(i._sources._nextSource=e),i._sources=e,t._node=e,i._flags&R&&t._subscribe(e),e;if(e._version===-1)return e._version=0,e._nextSource!==void 0&&(e._nextSource._prevSource=e._prevSource,e._prevSource!==void 0&&(e._prevSource._nextSource=e._nextSource),e._prevSource=i._sources,e._nextSource=void 0,i._sources._nextSource=e,i._sources=e),e}function l(t){this._value=t,this._version=0,this._node=void 0,this._targets=void 0}l.prototype.brand=Oe;l.prototype._refresh=function(){return!0};l.prototype._subscribe=function(t){this._targets!==t&&t._prevTarget===void 0&&(t._nextTarget=this._targets,this._targets!==void 0&&(this._targets._prevTarget=t),this._targets=t)};l.prototype._unsubscribe=function(t){if(this._targets!==void 0){let e=t._prevTarget,r=t._nextTarget;e!==void 0&&(e._nextTarget=r,t._prevTarget=void 0),r!==void 0&&(r._prevTarget=e,t._nextTarget=void 0),t===this._targets&&(this._targets=r)}};l.prototype.subscribe=function(t){return J(()=>{let e=this.value,r=i;i=void 0;try{t(e)}finally{i=r}})};l.prototype.valueOf=function(){return this.value};l.prototype.toString=function(){return this.value+""};l.prototype.toJSON=function(){return this.value};l.prototype.peek=function(){let t=i;i=void 0;try{return this.value}finally{i=t}};Object.defineProperty(l.prototype,"value",{get(){let t=ge(this);return t!==void 0&&(t._version=this._version),this._value},set(t){if(t!==this._value){if(H>100)throw d;this._value=t,this._version++,M++,j();try{for(let e=this._targets;e!==void 0;e=e._nextTarget)e._target._notify()}finally{G()}}}});function U(t){return new l(t)}function he(t){for(let e=t._sources;e!==void 0;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function _e(t){for(let e=t._sources;e!==void 0;e=e._nextSource){let r=e._source._node;if(r!==void 0&&(e._rollbackNode=r),e._source._node=e,e._version=-1,e._nextSource===void 0){t._sources=e;break}}}function me(t){let e=t._sources,r;for(;e!==void 0;){let n=e._prevSource;e._version===-1?(e._source._unsubscribe(e),n!==void 0&&(n._nextSource=e._nextSource),e._nextSource!==void 0&&(e._nextSource._prevSource=n)):r=e,e._source._node=e._rollbackNode,e._rollbackNode!==void 0&&(e._rollbackNode=void 0),e=n}t._sources=r}function x(t){l.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=M-1,this._flags=N}x.prototype=new l;x.prototype._refresh=function(){if(this._flags&=~E,this._flags&g)return!1;if((this._flags&(N|R))===R||(this._flags&=~N,this._globalVersion===M))return!0;if(this._globalVersion=M,this._flags|=g,this._version>0&&!he(this))return this._flags&=~g,!0;let t=i;try{_e(this),i=this;let e=this._fn();(this._flags&k||this._value!==e||this._version===0)&&(this._value=e,this._flags&=~k,this._version++)}catch(e){this._value=e,this._flags|=k,this._version++}return i=t,me(this),this._flags&=~g,!0};x.prototype._subscribe=function(t){if(this._targets===void 0){this._flags|=N|R;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._subscribe(e)}l.prototype._subscribe.call(this,t)};x.prototype._unsubscribe=function(t){if(this._targets!==void 0&&(l.prototype._unsubscribe.call(this,t),this._targets===void 0)){this._flags&=~R;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e)}};x.prototype._notify=function(){if(!(this._flags&E)){this._flags|=N|E;for(let t=this._targets;t!==void 0;t=t._nextTarget)t._target._notify()}};Object.defineProperty(x.prototype,"value",{get(){if(this._flags&g)throw d;let t=ge(this);if(this._refresh(),t!==void 0&&(t._version=this._version),this._flags&k)throw this._value;return this._value}});function Se(t){return new x(t)}function ye(t){let e=t._cleanup;if(t._cleanup=void 0,typeof e=="function"){j();let r=i;i=void 0;try{e()}catch(n){throw t._flags&=~g,t._flags|=w,W(t),n}finally{i=r,G()}}}function W(t){for(let e=t._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,ye(t)}function De(t){if(i!==this)throw d;me(this),i=t,this._flags&=~g,this._flags&w&&W(this),G()}function L(t){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=R}L.prototype._callback=function(){let t=this._start();try{if(this._flags&w||this._fn===void 0)return;let e=this._fn();typeof e=="function"&&(this._cleanup=e)}finally{t()}};L.prototype._start=function(){if(this._flags&g)throw d;this._flags|=g,this._flags&=~w,ye(this),_e(this),j();let t=i;return i=this,De.bind(this,t)};L.prototype._notify=function(){this._flags&E||(this._flags|=E,this._nextBatchedEffect=A,A=this)};L.prototype._dispose=function(){this._flags|=w,this._flags&g||W(this)};function J(t){let e=new L(t);try{e._callback()}catch(r){throw e._dispose(),r}return e._dispose.bind(e)}var V=class{get value(){return K(this)}set value(e){de(()=>Ae(this,e))}peek(){return K(this,{peek:!0})}},C=t=>Object.assign(new V,Object.entries(t).reduce((e,[r,n])=>{if(["value","peek"].some(s=>s===r))throw T;return typeof n!="object"||n===null||Array.isArray(n)?e[r]=U(n):e[r]=C(n),e},{})),Ae=(t,e)=>Object.keys(e).forEach(r=>t[r].value=e[r]),K=(t,{peek:e=!1}={})=>Object.entries(t).reduce((r,[n,s])=>(s instanceof l?r[n]=e?s.peek():s.value:s instanceof V&&(r[n]=K(s,{peek:e})),r),{});function Y(t,e){if(typeof e!="object"||Array.isArray(e)||!e)return JSON.parse(JSON.stringify(e));if(typeof e=="object"&&e.toJSON!==void 0&&typeof e.toJSON=="function")return e.toJSON();let r=t;return typeof t!="object"&&(r={...e}),Object.keys(e).forEach(n=>{r.hasOwnProperty(n)||(r[n]=e[n]),e[n]===null?delete r[n]:r[n]=Y(r[n],e[n])}),r}var xe="0.20.0-beta-2";var Pe=t=>t.pluginType===m,Ne=t=>t.pluginType===se,Le=t=>t.pluginType===b,Ce=t=>t.pluginType===re,B=class{constructor(){this.plugins=[];this.store=C({_dsPlugins:{}});this.preprocessors=new Array;this.actions={};this.watchers=new Array;this.refs={};this.reactivity={signal:U,computed:Se,effect:J};this.parentID="";this.missingIDNext=0;this.removals=new Map;this.mergeRemovals=new Array;this.lastMarshalledStore=""}get version(){return xe}load(...e){let r=new Set(this.plugins);e.forEach(n=>{if(n.requiredPlugins){for(let o of n.requiredPlugins)if(!r.has(o))throw T}let s;if(Pe(n)){if(this.preprocessors.includes(n))throw D;this.preprocessors.push(n)}else if(Ne(n)){if(this.watchers.includes(n))throw D;this.watchers.push(n),s=n.onGlobalInit}else if(Ce(n)){if(this.actions[n.name])throw D;this.actions[n.name]=n}else if(Le(n)){if(this.plugins.includes(n))throw D;this.plugins.push(n),s=n.onGlobalInit}else throw F;s&&s({store:()=>this.store,upsertSignal:this.upsertSignal.bind(this),mergeSignals:this.mergeSignals.bind(this),removeSignals:this.removeSignals.bind(this),actions:this.actions,reactivity:this.reactivity,applyPlugins:this.applyPlugins.bind(this),cleanup:this.cleanup.bind(this)}),r.add(n)}),this.applyPlugins(document.body)}cleanup(e){let r=this.removals.get(e);if(r){for(let n of r.set)n();this.removals.delete(e)}}mergeSignals(e){this.mergeRemovals.forEach(s=>s()),this.mergeRemovals=this.mergeRemovals.slice(0);let r=Y(this.store.value,e);this.store=C(r),JSON.stringify(this.store.value),this.lastMarshalledStore}removeSignals(...e){let r={...this.store.value};for(let n of e){let s=n.split("."),o=s[0],a=r;for(let f=1;f<s.length;f++){let c=s[f];a[o]||(a[o]={}),a=a[o],o=c}delete a[o]}this.store=C(r),this.applyPlugins(document.body)}upsertSignal(e,r){let n=e.split("."),s=this.store;for(let c=0;c<n.length-1;c++){let O=n[c];s[O]||(s[O]={}),s=s[O]}let o=n[n.length-1],a=s[o];if(a)return a;let f=this.reactivity.signal(r);return s[o]=f,f}applyPlugins(e){let r=new Set;this.plugins.forEach((n,s)=>{this.walkDownDOM(e,o=>{s||this.cleanup(o);for(let a in o.dataset){let f=`${o.dataset[a]}`||"",c=f;if(!a.startsWith(n.name))continue;if(o.id.length===0&&(o.id=`ds-${this.parentID}-${this.missingIDNext++}`),r.clear(),n.allowedTagRegexps){let u=o.tagName.toLowerCase();if(![...n.allowedTagRegexps].some(h=>u.match(h)))throw T}let O=a.slice(n.name.length),[S,...Te]=O.split(".");if(n.mustHaveEmptyKey&&S.length>0)throw d;if(n.mustNotEmptyKey&&S.length===0)throw d;S.length&&(S=S[0].toLowerCase()+S.slice(1));let q=Te.map(u=>{let[y,...h]=u.split("_");return{label:y,args:h}});if(n.allowedModifiers){for(let u of q)if(!n.allowedModifiers.has(u.label))throw T}let z=new Map;for(let u of q)z.set(u.label,u.args);if(n.mustHaveEmptyExpression&&c.length)throw d;if(n.mustNotEmptyExpression&&!c.length)throw d;let X=/;|\n/;n.removeNewLines&&(c=c.split(`
`).map(u=>u.trim()).join(" "));let Ee=[...n.preprocessors?.pre||[],...this.preprocessors,...n.preprocessors?.post||[]];for(let u of Ee){if(r.has(u))continue;r.add(u);let y=c.split(X),h=[];y.forEach(p=>{let _=p,Q=[..._.matchAll(u.regexp)];if(Q.length)for(let ee of Q){if(!ee.groups)continue;let{groups:te}=ee,{whole:Re}=te;_=_.replace(Re,u.replacer(te))}h.push(_)}),c=h.join("; ")}let $={store:()=>this.store,mergeSignals:this.mergeSignals.bind(this),upsertSignal:this.upsertSignal.bind(this),removeSignals:this.removeSignals.bind(this),applyPlugins:this.applyPlugins.bind(this),cleanup:this.cleanup.bind(this),walkSignals:this.walkSignals.bind(this),actions:this.actions,reactivity:this.reactivity,el:o,rawKey:a,key:S,rawExpression:f,expression:c,expressionFn:()=>{throw fe},modifiers:z};if(!n.bypassExpressionFunctionCreation?.($)&&!n.mustHaveEmptyExpression&&c.length){let u=c.split(X).map(p=>p.trim()).filter(p=>p.length);u[u.length-1]=`return ${u[u.length-1]}`;let y=u.map(p=>`  ${p}`).join(`;
`),h=`
  try {
    const _datastarExpression = () => {
  ${y}
    }
    const _datastarReturnVal = _datastarExpression()
    return _datastarReturnVal
  } catch (e) {
   const msg = \`
  Error evaluating Datastar expression:
  ${y.replaceAll("`","\\`")}

  Error: \${e.message}

  Check if the expression is valid before raising an issue.
  \`.trim()
   console.error(msg)
   debugger
  }
              `;try{let p=n.argumentNames||[],_=new Function("ctx",...p,h);$.expressionFn=_}catch(p){let _=new Error(`${p}
with
${h}`);console.error(_);debugger}}let Z=n.onLoad($);Z&&(this.removals.has(o)||this.removals.set(o,{id:o.id,set:new Set}),this.removals.get(o).set.add(Z))}})})}walkSignalsStore(e,r){let n=Object.keys(e);for(let s=0;s<n.length;s++){let o=n[s],a=e[o],f=a instanceof l,c=typeof a=="object"&&Object.keys(a).length>0;if(f){r(o,a);continue}c&&this.walkSignalsStore(a,r)}}walkSignals(e){this.walkSignalsStore(this.store,e)}walkDownDOM(e,r,n=0){if(!e)return;let s=pe(e);if(s)for(r(s),n=0,e=e.firstElementChild;e;)this.walkDownDOM(e,r,n++),e=e.nextElementSibling}};var Ie={Morph:"morph",Inner:"inner",Outer:"outer",Prepend:"prepend",Append:"append",Before:"before",After:"after",UpsertAttributes:"upsertAttributes"},mt=Ie.Morph;var be=new B;be.load(le,ce,ae,oe,ne);var ve=be;ve.load();})();
//# sourceMappingURL=datastar-core.js.map
