"use strict";(()=>{var Z={pluginType:"attribute",name:"star",onLoad:()=>{alert("YOU ARE PROBABLY OVERCOMPLICATING IT")}};var Q="action",X="watcher",m="preprocessor",v="attribute";var ee={pluginType:v,name:"computed",mustNotEmptyKey:!0,onLoad:t=>{let e=t.signals();return e[t.key]=t.reactivity.computed(()=>t.expressionFn(t)),()=>{let s=t.signals();delete s[t.key]}}};function te(t,e,s){let n={};if(!s)Object.assign(n,e);else for(let r in e){let i=t[r]?.value;i==null&&(n[r]=e[r])}return n}var ne="signals",se={pluginType:v,name:ne,removeNewLines:!0,preprocessors:{pre:[{pluginType:m,name:ne,regexp:/(?<whole>.+)/g,replacer:t=>{let{whole:e}=t;return`Object.assign({...ctx.signals()}, ${e})`}}]},allowedModifiers:new Set(["ifmissing"]),onLoad:t=>{let e=t.expressionFn(t),s=te(t.signals(),e,t.modifiers.has("ifmissing"));t.mergeSignals(s),delete t.el.dataset[t.rawKey]}};var re="[a-zA-Z_$]+",be=re+"[0-9a-zA-Z_$.]*";function O(t,e,s,n=!0){let r=n?be:re;return new RegExp(`(?<whole>${t}(?<${e}>${r})${s})`,"g")}var ie={name:"action",pluginType:m,regexp:O("\\$","action","(?<call>\\((?<args>.*)\\))",!1),replacer:({action:t,args:e})=>{let s=["ctx"];e&&s.push(...e.split(",").map(r=>r.trim()));let n=s.join(",");return`ctx.actions.${t}.method(${n})`}};var oe={name:"signal",pluginType:m,regexp:O("\\$","signal","(?<method>\\([^\\)]*\\))?"),replacer:t=>{let{signal:e,method:s}=t,n="ctx.signals()";if(!s?.length)return`${n}.${e}.value`;let r=e.split("."),i=r.pop(),o=r.join(".");return`${n}.${o}.value.${i}${s}`}};function ae(t){return t instanceof HTMLElement||t instanceof SVGElement?t:null}var Te=Symbol.for("preact-signals"),g=1,x=2,P=4,T=8,A=16,b=32;function C(){w++}function L(){if(w>1){w--;return}let t,e=!1;for(;E!==void 0;){let s=E;for(E=void 0,G++;s!==void 0;){let n=s._nextBatchedEffect;if(s._nextBatchedEffect=void 0,s._flags&=~x,!(s._flags&T)&&ce(s))try{s._callback()}catch(r){e||(t=r,e=!0)}s=n}}if(G=0,w--,e)throw t}function le(t){if(w>0)return t();C();try{return t()}finally{L()}}var a;var E,w=0,G=0,N=0;function ue(t){if(a===void 0)return;let e=t._node;if(e===void 0||e._target!==a)return e={_version:0,_source:t,_prevSource:a._sources,_nextSource:void 0,_target:a,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},a._sources!==void 0&&(a._sources._nextSource=e),a._sources=e,t._node=e,a._flags&b&&t._subscribe(e),e;if(e._version===-1)return e._version=0,e._nextSource!==void 0&&(e._nextSource._prevSource=e._prevSource,e._prevSource!==void 0&&(e._prevSource._nextSource=e._nextSource),e._prevSource=a._sources,e._nextSource=void 0,a._sources._nextSource=e,a._sources=e),e}function u(t){this._value=t,this._version=0,this._node=void 0,this._targets=void 0}u.prototype.brand=Te;u.prototype._refresh=function(){return!0};u.prototype._subscribe=function(t){this._targets!==t&&t._prevTarget===void 0&&(t._nextTarget=this._targets,this._targets!==void 0&&(this._targets._prevTarget=t),this._targets=t)};u.prototype._unsubscribe=function(t){if(this._targets!==void 0){let e=t._prevTarget,s=t._nextTarget;e!==void 0&&(e._nextTarget=s,t._prevTarget=void 0),s!==void 0&&(s._prevTarget=e,t._nextTarget=void 0),t===this._targets&&(this._targets=s)}};u.prototype.subscribe=function(t){return V(()=>{let e=this.value,s=a;a=void 0;try{t(e)}finally{a=s}})};u.prototype.valueOf=function(){return this.value};u.prototype.toString=function(){return this.value+""};u.prototype.toJSON=function(){return this.value};u.prototype.peek=function(){let t=a;a=void 0;try{return this.value}finally{a=t}};Object.defineProperty(u.prototype,"value",{get(){let t=ue(this);return t!==void 0&&(t._version=this._version),this._value},set(t){if(t!==this._value){if(G>100)throw new Error("Cycle detected");this._value=t,this._version++,N++,C();try{for(let e=this._targets;e!==void 0;e=e._nextTarget)e._target._notify()}finally{L()}}}});function I(t){return new u(t)}function ce(t){for(let e=t._sources;e!==void 0;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function fe(t){for(let e=t._sources;e!==void 0;e=e._nextSource){let s=e._source._node;if(s!==void 0&&(e._rollbackNode=s),e._source._node=e,e._version=-1,e._nextSource===void 0){t._sources=e;break}}}function pe(t){let e=t._sources,s;for(;e!==void 0;){let n=e._prevSource;e._version===-1?(e._source._unsubscribe(e),n!==void 0&&(n._nextSource=e._nextSource),e._nextSource!==void 0&&(e._nextSource._prevSource=n)):s=e,e._source._node=e._rollbackNode,e._rollbackNode!==void 0&&(e._rollbackNode=void 0),e=n}t._sources=s}function S(t){u.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=N-1,this._flags=P}S.prototype=new u;S.prototype._refresh=function(){if(this._flags&=~x,this._flags&g)return!1;if((this._flags&(P|b))===b||(this._flags&=~P,this._globalVersion===N))return!0;if(this._globalVersion=N,this._flags|=g,this._version>0&&!ce(this))return this._flags&=~g,!0;let t=a;try{fe(this),a=this;let e=this._fn();(this._flags&A||this._value!==e||this._version===0)&&(this._value=e,this._flags&=~A,this._version++)}catch(e){this._value=e,this._flags|=A,this._version++}return a=t,pe(this),this._flags&=~g,!0};S.prototype._subscribe=function(t){if(this._targets===void 0){this._flags|=P|b;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._subscribe(e)}u.prototype._subscribe.call(this,t)};S.prototype._unsubscribe=function(t){if(this._targets!==void 0&&(u.prototype._unsubscribe.call(this,t),this._targets===void 0)){this._flags&=~b;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e)}};S.prototype._notify=function(){if(!(this._flags&x)){this._flags|=P|x;for(let t=this._targets;t!==void 0;t=t._nextTarget)t._target._notify()}};Object.defineProperty(S.prototype,"value",{get(){if(this._flags&g)throw new Error("Cycle detected");let t=ue(this);if(this._refresh(),t!==void 0&&(t._version=this._version),this._flags&A)throw this._value;return this._value}});function de(t){return new S(t)}function ge(t){let e=t._cleanup;if(t._cleanup=void 0,typeof e=="function"){C();let s=a;a=void 0;try{e()}catch(n){throw t._flags&=~g,t._flags|=T,U(t),n}finally{a=s,L()}}}function U(t){for(let e=t._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,ge(t)}function Ee(t){if(a!==this)throw new Error("Out-of-order effect");pe(this),a=t,this._flags&=~g,this._flags&T&&U(this),L()}function R(t){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=b}R.prototype._callback=function(){let t=this._start();try{if(this._flags&T||this._fn===void 0)return;let e=this._fn();typeof e=="function"&&(this._cleanup=e)}finally{t()}};R.prototype._start=function(){if(this._flags&g)throw new Error("Cycle detected");this._flags|=g,this._flags&=~T,ge(this),fe(this),C();let t=a;return a=this,Ee.bind(this,t)};R.prototype._notify=function(){this._flags&x||(this._flags|=x,this._nextBatchedEffect=E,E=this)};R.prototype._dispose=function(){this._flags|=T,this._flags&g||U(this)};function V(t){let e=new R(t);try{e._callback()}catch(s){throw e._dispose(),s}return e._dispose.bind(e)}var k=class{get value(){return B(this)}set value(e){le(()=>we(this,e))}peek(){return B(this,{peek:!0})}},D=t=>Object.assign(new k,Object.entries(t).reduce((e,[s,n])=>{if(["value","peek"].some(r=>r===s))throw new Error(`${s} is a reserved property name`);return typeof n!="object"||n===null||Array.isArray(n)?e[s]=I(n):e[s]=D(n),e},{})),we=(t,e)=>Object.keys(e).forEach(s=>t[s].value=e[s]),B=(t,{peek:e=!1}={})=>Object.entries(t).reduce((s,[n,r])=>(r instanceof u?s[n]=e?r.peek():r.value:r instanceof k&&(s[n]=B(r,{peek:e})),s),{});function F(t,e){if(typeof e!="object"||Array.isArray(e)||!e)return JSON.parse(JSON.stringify(e));if(typeof e=="object"&&e.toJSON!==void 0&&typeof e.toJSON=="function")return e.toJSON();let s=t;return typeof t!="object"&&(s={...e}),Object.keys(e).forEach(n=>{s.hasOwnProperty(n)||(s[n]=e[n]),e[n]===null?delete s[n]:s[n]=F(s[n],e[n])}),s}var he="0.20.0";var Pe=t=>t.pluginType===m,Re=t=>t.pluginType===X,De=t=>t.pluginType===v,Oe=t=>t.pluginType===Q,M=(t,e)=>new Error(`A ${t} named '${e}' already exists`),j=class{constructor(){this.plugins=[];this.signals=D({_dsPlugins:{}});this.preprocessors=new Array;this.actions={};this.watchers=new Array;this.refs={};this.reactivity={signal:I,computed:de,effect:V};this.parentID="";this.missingIDNext=0;this.removals=new Map;this.mergeRemovals=new Array;this.lastMarshalledSignals=""}get version(){return he}load(...e){let s=new Set(this.plugins);e.forEach(n=>{if(n.requiredPlugins){for(let i of n.requiredPlugins)if(!s.has(i))throw new Error(`Plugin '${n.name}' requires plugin '${i}' to be loaded`)}let r;if(Pe(n)){if(this.preprocessors.includes(n))throw M("Preprocessor",n.name);this.preprocessors.push(n)}else if(Re(n)){if(this.watchers.includes(n))throw M("Watcher",n.name);this.watchers.push(n),r=n.onGlobalInit}else if(Oe(n)){if(this.actions[n.name])throw M("Action",n.name);this.actions[n.name]=n}else if(De(n)){if(this.plugins.includes(n))throw M("Attribute",n.name);this.plugins.push(n),r=n.onGlobalInit}else throw new Error(`Unknown plugin type: ${n}`);r&&r({signals:()=>this.signals,upsertIfMissingSignals:this.upsertIfMissingSignals.bind(this),mergeSignals:this.MergeSignals.bind(this),removeSignals:this.removeSignals.bind(this),actions:this.actions,reactivity:this.reactivity,applyPlugins:this.applyPlugins.bind(this),cleanupElementRemovals:this.cleanupElementRemovals.bind(this)}),s.add(n)}),this.applyPlugins(document.body)}cleanupElementRemovals(e){let s=this.removals.get(e);if(s){for(let n of s.set)n();this.removals.delete(e)}}MergeSignals(e){this.mergeRemovals.forEach(r=>r()),this.mergeRemovals=this.mergeRemovals.slice(0);let s=F(this.signals.value,e);this.signals=D(s),JSON.stringify(this.signals.value),this.lastMarshalledSignals}removeSignals(...e){let s={...this.signals.value};for(let n of e){let r=n.split("."),i=r[0],o=s;for(let f=1;f<r.length;f++){let c=r[f];o[i]||(o[i]={}),o=o[i],i=c}delete o[i]}this.signals=D(s),this.applyPlugins(document.body)}upsertIfMissingSignals(e,s){let n=e.split("."),r=this.signals;for(let o=0;o<n.length-1;o++){let f=n[o];r[f]||(r[f]={}),r=r[f]}let i=n[n.length-1];r[i]||(r[i]=this.reactivity.signal(s))}signalByName(e){return this.signals[e]}applyPlugins(e){let s=new Set;this.plugins.forEach((n,r)=>{this.walkDownDOM(e,i=>{r||this.cleanupElementRemovals(i);for(let o in i.dataset){let f=`${i.dataset[o]}`||"",c=f;if(!o.startsWith(n.name))continue;if(i.id.length===0&&(i.id=`ds-${this.parentID}-${this.missingIDNext++}`),s.clear(),n.allowedTagRegexps){let l=i.tagName.toLowerCase();if(![...n.allowedTagRegexps].some(p=>l.match(p)))throw new Error(`'${i.tagName}' not allowed for '${o}', allowed ${[[...n.allowedTagRegexps].map(p=>`'${p}'`)].join(", ")}`)}let ye=o.slice(n.name.length),[_,...Se]=ye.split(".");if(n.mustHaveEmptyKey&&_.length>0)throw new Error(`'${o}' must have empty key`);if(n.mustNotEmptyKey&&_.length===0)throw new Error(`'${o}' must have non-empty key`);_.length&&(_=_[0].toLowerCase()+_.slice(1));let H=Se.map(l=>{let[y,...p]=l.split("_");return{label:y,args:p}});if(n.allowedModifiers){for(let l of H)if(!n.allowedModifiers.has(l.label))throw new Error(`'${l.label}' is not allowed`)}let J=new Map;for(let l of H)J.set(l.label,l.args);if(n.mustHaveEmptyExpression&&c.length)throw new Error(`'${o}' must have empty expression`);if(n.mustNotEmptyExpression&&!c.length)throw new Error(`'${o}' must have non-empty expression`);let W=/;|\n/;n.removeNewLines&&(c=c.split(`
`).map(l=>l.trim()).join(" "));let ve=[...n.preprocessors?.pre||[],...this.preprocessors,...n.preprocessors?.post||[]];for(let l of ve){if(s.has(l))continue;s.add(l);let y=c.split(W),p=[];y.forEach(d=>{let h=d,Y=[...h.matchAll(l.regexp)];if(Y.length)for(let q of Y){if(!q.groups)continue;let{groups:z}=q,{whole:xe}=z;h=h.replace(xe,l.replacer(z))}p.push(h)}),c=p.join("; ")}let $={signals:()=>this.signals,mergeSignals:this.MergeSignals.bind(this),upsertIfMissingSignals:this.upsertIfMissingSignals.bind(this),removeSignals:this.removeSignals.bind(this),applyPlugins:this.applyPlugins.bind(this),cleanupElementRemovals:this.cleanupElementRemovals.bind(this),walkSignals:this.walkMySignals.bind(this),actions:this.actions,reactivity:this.reactivity,el:i,rawKey:o,key:_,rawExpression:f,expression:c,expressionFn:()=>{throw new Error("Expression function not created")},modifiers:J};if(!n.bypassExpressionFunctionCreation?.($)&&!n.mustHaveEmptyExpression&&c.length){let l=c.split(W).map(d=>d.trim()).filter(d=>d.length);l[l.length-1]=`return ${l[l.length-1]}`;let y=l.map(d=>`  ${d}`).join(`;
`),p=`
  try {
    const _datastarExpression = () => {
  ${y}
    }
    const _datastarReturnVal = _datastarExpression()
    return _datastarReturnVal
  } catch (e) {
   const msg = \`
  Error evaluating Datastar expression:
  ${y.replaceAll("`","\\`")}

  Error: \${e.message}

  Check if the expression is valid before raising an issue.
  \`.trim()
   console.error(msg)
   debugger
  }
              `;try{let d=n.argumentNames||[],h=new Function("ctx",...d,p);$.expressionFn=h}catch(d){let h=new Error(`Error creating expression function for '${p}', error: ${d}`);console.error(h);debugger}}let K=n.onLoad($);K&&(this.removals.has(i)||this.removals.set(i,{id:i.id,set:new Set}),this.removals.get(i).set.add(K))}})})}walkSignals(e,s){let n=Object.keys(e);for(let r=0;r<n.length;r++){let i=n[r],o=e[i],f=o instanceof u,c=typeof o=="object"&&Object.keys(o).length>0;if(f){s(i,o);continue}c&&this.walkSignals(o,s)}}walkMySignals(e){this.walkSignals(this.signals,e)}walkDownDOM(e,s,n=0){if(!e)return;let r=ae(e);if(r)for(s(r),n=0,e=e.firstElementChild;e;)this.walkDownDOM(e,s,n++),e=e.nextElementSibling}};var Ae={Morph:"morph",Inner:"inner",Outer:"outer",Prepend:"prepend",Append:"append",Before:"before",After:"after",UpsertAttributes:"upsertAttributes"},at=Ae.Morph;var me=new j;me.load(ie,oe,se,ee,Z);var _e=me;_e.load();})();
//# sourceMappingURL=datastar-core.js.map
